<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å¾Œç«¯ä¸²æ¥æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”— å‰å¾Œç«¯ä¸²æ¥æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2>1. å¾Œç«¯é€£ç·šæ¸¬è©¦</h2>
        <button onclick="testBackendConnection()">æ¸¬è©¦å¾Œç«¯é€£ç·š</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h2>2. ç”¨æˆ¶è¨»å†Šæ¸¬è©¦</h2>
        <input type="text" id="register-name" placeholder="å§“å" value="æ¸¬è©¦ç”¨æˆ¶">
        <input type="email" id="register-email" placeholder="Email" value="test@example.com">
        <input type="password" id="register-password" placeholder="å¯†ç¢¼" value="test123">
        <select id="register-gender">
            <option value="male">ç”·</option>
            <option value="female">å¥³</option>
        </select>
        <input type="number" id="register-age" placeholder="å¹´é½¡" value="25">
        <button onclick="testRegister()">æ¸¬è©¦è¨»å†Š</button>
        <div id="register-result"></div>
    </div>

    <div class="test-section">
        <h2>3. ç”¨æˆ¶ç™»å…¥æ¸¬è©¦</h2>
        <input type="email" id="login-email" placeholder="Email" value="test@example.com">
        <input type="password" id="login-password" placeholder="å¯†ç¢¼" value="test123">
        <button onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>4. èª²ç¨‹è³‡æ–™æ¸¬è©¦</h2>
        <button onclick="testGetCourses()">ç²å–èª²ç¨‹åˆ—è¡¨</button>
        <div id="courses-result"></div>
    </div>

    <div class="test-section">
        <h2>5. èªè­‰æ¸¬è©¦</h2>
        <button onclick="testAuthenticatedRequest()">æ¸¬è©¦éœ€è¦èªè­‰çš„è«‹æ±‚</button>
        <div id="auth-result"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';
        let authToken = null;

        // é€šç”¨è«‹æ±‚å‡½æ•¸
        async function makeRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            };

            try {
                const response = await fetch(`${API_BASE}${url}`, finalOptions);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, result) {
            const element = document.getElementById(elementId);
            const isSuccess = result.success;
            element.className = `test-section ${isSuccess ? 'success' : 'error'}`;
            element.innerHTML = `
                <h4>${isSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
        }

        // 1. æ¸¬è©¦å¾Œç«¯é€£ç·š
        async function testBackendConnection() {
            const result = await makeRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ account: 'test', password: 'test' })
            });
            showResult('connection-result', {
                success: result.status !== undefined,
                message: result.status !== undefined ? 'å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ' : 'ç„¡æ³•é€£æ¥å¾Œç«¯',
                details: result
            });
        }

        // 2. æ¸¬è©¦è¨»å†Š
        async function testRegister() {
            const userData = {
                name: document.getElementById('register-name').value,
                account: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
                gender: document.getElementById('register-gender').value,
                age: parseInt(document.getElementById('register-age').value),
                role: 'student'
            };

            const result = await makeRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            showResult('register-result', result);
        }

        // 3. æ¸¬è©¦ç™»å…¥
        async function testLogin() {
            const loginData = {
                account: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value
            };

            const result = await makeRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify(loginData)
            });

            if (result.success && result.data.access_token) {
                authToken = result.data.access_token;
                result.message = 'ç™»å…¥æˆåŠŸï¼ŒTokenå·²ä¿å­˜';
            }
            showResult('login-result', result);
        }

        // 4. æ¸¬è©¦ç²å–èª²ç¨‹
        async function testGetCourses() {
            const result = await makeRequest('/course/courseinfo');
            showResult('courses-result', result);
        }

        // 5. æ¸¬è©¦èªè­‰è«‹æ±‚
        async function testAuthenticatedRequest() {
            if (!authToken) {
                showResult('auth-result', {
                    success: false,
                    message: 'è«‹å…ˆç™»å…¥ç²å–Token'
                });
                return;
            }

            const result = await makeRequest('/users/profile');
            showResult('auth-result', result);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
        window.onload = function() {
            testBackendConnection();
        };
    </script>
</body>
</html>