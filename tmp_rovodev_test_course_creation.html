<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹å‰µå»ºæ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, select, textarea { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ“ èª²ç¨‹å‰µå»ºæ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2>1. å…ˆç™»å…¥ç²å–Token</h2>
        <input type="email" id="login-email" placeholder="Email" value="test@example.com">
        <input type="password" id="login-password" placeholder="å¯†ç¢¼" value="test123">
        <button onclick="login()">ç™»å…¥</button>
        <div id="login-result"></div>
        <p>Tokenç‹€æ…‹: <span id="token-status">âŒ æœªè¨­ç½®</span></p>
    </div>

    <div class="test-section">
        <h2>2. å‰µå»ºèª²ç¨‹</h2>
        <input type="text" id="course-subject" placeholder="èª²ç¨‹ç§‘ç›®" value="æ•¸å­¸">
        <textarea id="course-description" placeholder="èª²ç¨‹æè¿°">é«˜ä¸­æ•¸å­¸èª²ç¨‹</textarea><br>
        <input type="number" id="course-price" placeholder="åƒ¹æ ¼" value="500">
        <input type="text" id="course-location" placeholder="åœ°é»" value="å°åŒ—">
        <button onclick="createCourse()" id="create-btn" disabled>å‰µå»ºèª²ç¨‹</button>
        <div id="course-result"></div>
    </div>

    <div class="test-section">
        <h2>3. æ¸¬è©¦çµæœ</h2>
        <div id="final-result"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000/api';
        let authToken = null;

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, result) {
            const element = document.getElementById(elementId);
            const isSuccess = result.success;
            element.className = `test-section ${isSuccess ? 'success' : 'error'}`;
            element.innerHTML = `
                <h4>${isSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
        }

        // ç™»å…¥
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: email, password: password })
                });

                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    authToken = data.access_token;
                    document.getElementById('token-status').innerHTML = 'âœ… å·²è¨­ç½®';
                    document.getElementById('create-btn').disabled = false;
                    showResult('login-result', {
                        success: true,
                        message: 'ç™»å…¥æˆåŠŸ',
                        token: authToken.substring(0, 20) + '...'
                    });
                } else {
                    showResult('login-result', {
                        success: false,
                        message: 'ç™»å…¥å¤±æ•—',
                        error: data
                    });
                }
            } catch (error) {
                showResult('login-result', {
                    success: false,
                    message: 'ç¶²è·¯éŒ¯èª¤',
                    error: error.message
                });
            }
        }

        // å‰µå»ºèª²ç¨‹
        async function createCourse() {
            if (!authToken) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            const courseData = {
                subject: document.getElementById('course-subject').value,
                description: document.getElementById('course-description').value,
                price: parseFloat(document.getElementById('course-price').value),
                location: document.getElementById('course-location').value,
                teacher_id: 1 // æš«æ™‚ä½¿ç”¨å›ºå®šå€¼
            };

            try {
                const response = await fetch(`${API_BASE}/course/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(courseData)
                });

                const data = await response.json();
                
                showResult('course-result', {
                    success: response.ok,
                    message: response.ok ? 'èª²ç¨‹å‰µå»ºæˆåŠŸ' : 'èª²ç¨‹å‰µå»ºå¤±æ•—',
                    data: data,
                    status: response.status
                });

                if (response.ok) {
                    document.getElementById('final-result').innerHTML = `
                        <div class="success">
                            <h3>ğŸ‰ èª²ç¨‹å‰µå»ºæˆåŠŸï¼</h3>
                            <p>èª²ç¨‹ID: ${data.course?.id || 'æœªçŸ¥'}</p>
                            <p>ç¾åœ¨å¯ä»¥å›åˆ°å‰ç«¯é é¢æ¸¬è©¦äº†ï¼</p>
                        </div>
                    `;
                }

            } catch (error) {
                showResult('course-result', {
                    success: false,
                    message: 'ç¶²è·¯éŒ¯èª¤',
                    error: error.message
                });
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥token
        window.onload = function() {
            const savedToken = localStorage.getItem('jwt');
            if (savedToken) {
                authToken = savedToken;
                document.getElementById('token-status').innerHTML = 'âœ… å·²è¨­ç½® (ä¾†è‡ªlocalStorage)';
                document.getElementById('create-btn').disabled = false;
            }
        };
    </script>
</body>
</html>